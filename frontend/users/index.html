<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Edificaciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="shortcut icon" href="#">
    <style>
      body {
            background-color: #1b1b1b;
            color: #ffffff;
        }
        h1 {
            margin-top: 0.5em;
            text-align: center;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        #texto {
            text-align: right;
        }
        p {
            font-size: 20px;
            padding-left: 20px;
            text-align: justify;
        }
        #info {
            background-color: #30303A;
            border-radius: 1em;
            padding: 0.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2em;
        }
        h2 {
            margin-top: 0.5em;
            margin-bottom: 1em;
        }
        .edificio-card {
            margin: 20px 0;
        }
        .centrado {
            display: flex;
            justify-content: center;
        }
        .card-body {
            padding: 1em;
        }
        .btn {
            margin: 0.5em;
        }
        .table {
            margin-top: 2em;
        }
        .text-success {
            color: #28a745; }

    </style>
</head>
<body data-bs-theme="dark">
    <input type="hidden" id="user-id">

    <div class="container">
        <div class="row">
            <div class="col">
                <h1 id="titulo">Gestionar Edificaciones</h1>
            </div>
        </div>
    </div>

    <div class="container" id="info">
        <div class="row g-4 centrado" id="edificaciones">
            <div class="col-md-4 edificio-card">
                <div class="card">
                    <img id="canon"   alt="Cañón">
                    <div class="card-body">
                        <h5 class="card-title">Cañón</h5>
                        <p class="card-text">Nivel: <span id="unlock_canon"></span><span id="nivel-canon">1</span><span id="money_given_canon"></span><span id="cost_canon"></span></p>
                        <button class="btn btn-primary" onclick="subirNivel('canon')">Subir de Nivel</button>
                    </div>
                </div>
            </div>

            <div class="col-md-4 edificio-card">
                <div class="card">
                    <img id="archer_tower"  alt="Torre Arquera">
                    <div class="card-body">
                        <h5 class="card-title">Torre Arquera</h5>
                        <p class="card-text">Nivel: <span id="unlock_archer_tower"></span><span id="nivel-archer_tower">1</span><span id="money_given_at"></span><span id="cost_archer_tower"></span></p>
                        <button class="btn btn-primary" onclick="subirNivel('archer_tower')">Subir de Nivel</button>
                    </div>
                </div>
            </div>

            <div class="col-md-4 edificio-card">
                <div class="card">
                    <img id="townhall"  alt="Ayuntamiento">
                    <div class="card-body">
                        <h5 class="card-title">Ayuntamiento</h5>
                        <p class="card-text">Nivel: <span id="nivel-townhall">1</span>
                        <span id="money_given_th"></span> <span id="cost_townhall"></span></p>
                        <button class="btn btn-primary" onclick="subirNivel('townhall')">Subir de Nivel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="text-center mt-4" id="coins">Ganancias Totales: $<span id="nivel-coin"></div></h2>
    <div class="container text-center mt-4" id="info">
        <button class="btn btn-success" onclick="recaudarGanancias()">Recaudar Todo</button>
    </div>

    <h2 class="text-center mt-4">Eliminar Personaje</h2>
    <div class="container text-center mt-4" id="info">
        <button class="btn btn-danger" onclick="eliminarPersonaje()">Eliminar Personaje</button>
    </div>

    <div id="mensaje-final" class="mt-4 text-center" style="display: none;">
        <h2 class="text-success">USTED HA GANADO</h2>
    </div>
    <style>
        img{
            max-width: 100%;
            max-height: 100%;
            height: 20em;
            width:10em;
        }
    </style>
    <script>
        const params=new URLSearchParams(window.location.search);
        const id=params.get("id");
        // Función para subir de nivel una edificación
        
        
                 
        
                // Función para cargar los datos del usuario y actualizar la interfaz
                function cargarDatosUsuario(userId) {
                    fetch(`http://127.0.0.1:5000/users/${userId}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('nivel-townhall').textContent = data.Town_Hall || 1;
                            document.getElementById('nivel-archer_tower').textContent = data.Archer_Tower || 1;
                            document.getElementById('nivel-canon').textContent = data.Canon || 1;
                            document.getElementById('nivel-coin').textContent = data.money || 0;
                        })
                        .catch(error => console.error('Error:', error));
                }
        
                // Asignar el ID del usuario al campo oculto y cargar datos del usuario
                document.addEventListener('DOMContentLoaded', function() {
                    const userId = id;
                    if (userId) {
                        document.getElementById('user-id').value = userId;
                        cargarDatosUsuario(userId);
                    }
                    
                });
                         

                function subirNivel(tipo) {
                    const userId = document.getElementById('user-id').value;
                    const nivelElemento = document.getElementById(`nivel-${tipo}`);
                    
                    let townhall_id = parseInt(document.getElementById('nivel-townhall').textContent);
                    let unlock=0;

                    if(tipo!="townhall" && tipo!="coin"){

                        unlock=document.getElementById(`unlock_${tipo}`);
                        unlock=parseInt(unlock.getAttribute("class"));
                        
                    }
                    if(tipo!='coin'){
                       
                        let plata = parseInt(document.getElementById('nivel-coin').textContent);
                        let subir=document.getElementById(`cost_${tipo}`);
                        let cuanto_sale=subir.getAttribute("class");

                    


                        if(plata>=parseInt(cuanto_sale) && townhall_id>=unlock){
                            let nivel = parseInt(nivelElemento.textContent) + 1;
                            nivelElemento.textContent = nivel;
                            plata=plata-parseInt(cuanto_sale);
                            
                            let ingreso=document.getElementById(`nivel-coin`);
                            ingreso.innerHTML=plata;
                            console.log(`baja plata:`+plata)
                        }else if (plata<parseInt(cuanto_sale)){
                            alert("You need more coins");
                            return;
                        }else{
                            alert("You need to increase your town hall level");
                            return;
                        }
                        

                    }else{
                        let coins_id=parseInt(nivelElemento.textContent);
                    }
                    
        
                    let id_th = parseInt(document.getElementById('nivel-townhall').textContent);
                    let id_AT = parseInt(document.getElementById('nivel-archer_tower').textContent);
                    let id_Canon = parseInt(document.getElementById('nivel-canon').textContent);
                    let id_coins = parseInt(document.getElementById('nivel-coin').textContent);
        
                    fetch(`http://127.0.0.1:5000/users/${userId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            Town_Hall: id_th,
                            Archer_Tower: id_AT,
                            Canon: id_Canon,
                            Coins: id_coins

                        })
                    })
                    .then((res) => res.json())
                    .then(data => {
                        console.log("Datos actualizados:", data)
                        if(tipo!="coin"){
                            window.location.reload();    
                        } })
                    .catch((error) => console.log("ERROR", error));

                    

                }
        

        function parse_data_monto(content){
            let monto_inicial = content.money;
            const coins=document.getElementById("nivel-coin");
            coins.innerHTML=monto_inicial;
            
            const img_AT=document.getElementById("archer_tower");
            img_AT.setAttribute("class",content.Archer_Tower)
            
            const img_canon=document.getElementById("canon");
            img_canon.setAttribute("class",content.Canon)

            const img_th=document.getElementById("townhall");
            img_th.setAttribute("class",content.Town_Hall);
            }  
            
        function parse_tower(content){
          
            const img=document.getElementById("archer_tower");
            const clase=img.getAttribute("class");  
            img.setAttribute("src",content[clase-1].img);

            const coins_at=document.getElementById("money_given_at");
            coins_at.setAttribute("class",content[clase-1].money_given);

            const cost_at=document.getElementById("cost_archer_tower");
            cost_at.setAttribute("class",content[clase-1].upgrade_cost);

            const unlock_at=document.getElementById("unlock_archer_tower");
            unlock_at.setAttribute("class",content[clase-1].unlock);
            }
            
        function parse_canon(content){
            const img=document.getElementById("canon");
            const clase=img.getAttribute("class");  
            img.setAttribute("src",content[clase-1].img);

            const coins_canon=document.getElementById("money_given_canon");
            coins_canon.setAttribute("class",content[clase-1].money_given);

            const cost_canon=document.getElementById("cost_canon");
            cost_canon.setAttribute("class",content[clase-1].upgrade_cost);

            const unlock_ca=document.getElementById("unlock_canon");
            unlock_ca.setAttribute("class",content[clase-1].unlock)
            }     
       
        function parse_townhall(content){
            const img=document.getElementById("townhall");
            const clase=img.getAttribute("class");  
            img.setAttribute("src",content[clase-1].img);

            const cost_th=document.getElementById("cost_townhall");
            cost_th.setAttribute("class",content[clase-1].upgrade_cost);
            }

        function response_received(response) {
            return response.json()
        }
        function request_error(error) {
            console.log("ERROR");
            console.log(error);
        } 
    
        function recaudarGanancias(){
            const container = document.getElementById("nivel-coin");
            let coin=container.innerHTML;
           
            const ArcherTower_id=document.getElementById("money_given_at");
            let clase_AT=ArcherTower_id.getAttribute("class");
            let money_at=parseInt(clase_AT)
            

            const canon_id=document.getElementById("money_given_canon");
            let clase_canon=canon_id.getAttribute("class");
            let money_canon=parseInt(clase_canon);
            

            coin=parseInt(coin)+money_at+money_canon;
            
            
            container.innerHTML=coin;
            console.log(coin);
            subirNivel("coin");

        }


        // Función para eliminar el personaje
        function eliminarPersonaje() {
            if (confirm('¿Estás seguro de que quieres eliminar este personaje?')) {
                const userId = id;

                if (!userId) {
                    alert('No se pudo encontrar el ID del usuario');
                    return;
                }

                fetch(`http://127.0.0.1:5000/users/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Usuario eliminado exitosamente');
                        window.location.href = 'http://127.0.0.1:8000/';
                    } else {
                        return response.json().then(data => {
                            alert(`Error: ${data.mensaje || data.error}`);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ocurrió un error al eliminar el usuario');
                });
            }
        }

        // Función para verificar si se ha ganado
        function verificarVictoria() {
            let nivelCañon = parseInt(document.getElementById('nivel-can').textContent);
            let nivelTorre = parseInt(document.getElementById('nivel-torre').textContent);
            let nivelAyuntamiento = parseInt(document.getElementById('nivel-ayuntamiento').textContent);

            if (nivelCañon >= 10 && nivelTorre >= 10 && nivelAyuntamiento >= 10) {
                document.getElementById('mensaje-final').style.display = 'block';
                document.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
            }
        }


        
        fetch("http://127.0.0.1:5000/users/"+id)
                        .then(response_received)  
                        .then(parse_data_monto)           
                        .catch(request_error)

        fetch("http://127.0.0.1:5000/archertower")
                        .then(response_received)  
                        .then(parse_tower)
                        .catch(request_error) 

         fetch("http://127.0.0.1:5000/canon")
                        .then(response_received)  
                        .then(parse_canon)
                        .catch(request_error)	
        
        fetch("http://127.0.0.1:5000/townhall")
                        .then(response_received)  
                        .then(parse_townhall)
                        .catch(request_error)	
    </script>
</body>
</html>
